<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ChatEST</title>

		<!-- bootstrap 5 -->
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
		/>

		<!-- style -->
		<link rel="stylesheet" href="/static/style.css" />
		<link rel="stylesheet" href="/static/scrollbar.css" />

		<!-- icon -->
		<link rel="icon" href="/static/assets/logo/openai-logo.png" />
	</head>

	<body>
		<div class="d-flex align-items-end position-relative">
			<!-- loadingView -->
			<div
				class="position-fixed top-0 start-0 loading-view"
				id="loading-view"
			>
				<div class="vw-100 vh-100 bg-black opacity-75">
					<div class="position-absolute top-50 start-50 translate-middle">
						<div class="spinner-border text-light" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
					</div>
				</div>
			</div>
			<!-- end loadingView -->

			<div
				class="d-flex flex-column justify-content-around align-content-around m-0 vw-100"
			>
				<h2 class="fw-bold text-white p-3">ChatEST</h2>

				<!-- Body -->
				<div class="container mw-100" id="chat-container"></div>
				<!-- end body -->

				<div class="pre-footer">&nbsp;</div>

				<!-- footer -->
				<footer class="position-relative p-0 h-100">
					<form method="POST" action="">
						<div
							class="position-fixed input-field bottom-0 start-0 text-center bg-dark w-100"
						>
							<div
								class="flex-column justify-content-center align-items-center px-5 pb-4 pt-2"
							>
								<div
									class="input-group rounded-3 row d-flex align-items-center"
								>
									<div class="col-11">{{form.prompt}}</div>
									<button
										class="send-btn ms-1 pe-2 me-1 col"
										id="addon-wrapping send-btn"
										type="submit"
										onclick="addMessage('user')"
									>
										<i class="far fa-paper-plane"></i>
									</button>
								</div>

								<div class="text-muted">
									<a
										href="https://github.com/HCMUS-Project/Chatbox"
										class="text-muted"
										>ChatEST source</a
									>
									Free Research Preview. ChatEST is not for commercial
									use.
								</div>
							</div>
							<button class="btn btn-warning" onclick="clearChat()">
								<i class="fas fa-trash-alt"></i>
								<span class="ps-2">Clear chat</span>
							</button>
						</div>
					</form>
				</footer>
				<!-- end footer -->
			</div>
		</div>
	</body>

	<script
		src="https://kit.fontawesome.com/c67e626608.js"
		crossorigin="anonymous"
	></script>

	<script>
		window.onload = function () {
			document.getElementById("prompt").value = "";

			let reloadFlag = false;

			try {
				reloadFlag = localStorage.getItem("reloadFlag");
			} catch (err) {
				console.log(err);
			}

			console.log("reload flag:" + reloadFlag);
			if (reloadFlag) {
				window.localStorage.clear();
				showLoadingView(false);
			} else addMessage("bot");
		};

		function addMessage(object) {
			object == "user" ? showLoadingView(true) : showLoadingView(false);

			const chatContainer = document.getElementById("chat-container");
			chatContainer.innerHTML = localStorage.getItem("Chat");

			let logo =
				object == "user"
					? "/static/assets/logo/User_logo.jpg"
					: "static/assets/logo/ChatGPT_logo.png";

			let message =
				object == "user"
					? document.getElementById("prompt").value
					: "{{message}}";

			let bgColor = object == "user" ? " bg-dark " : " bg-light-dark ";

			const msg =
				`<div class="chat-gpt-prompt row px-5 py-4 ` +
				bgColor +
				` gap-3">
							<img
								class="col-1 p-0 img-thumbnail bg-transparent border-0 align-content-end"
								src="` +
				logo +
				`"
								alt="logo"
							/>
							<p class="content col-11">` +
				message +
				`	</p>
						</div>
					`;

			chatContainer.innerHTML += msg;

			localStorage.setItem("Chat", chatContainer.innerHTML);
			window.scrollTo(
				0,
				document.body.scrollHeight || document.documentElement.scrollHeight,
			);
		}

		function showLoadingView(isShow) {
			let loadingView = document.getElementById("loading-view");
			loadingView.style.display = isShow ? "block" : "none";
		}

		function clearChat() {
			document.getElementById("prompt").value = "";
			window.localStorage.clear();

			localStorage.setItem("reloadFlag", true);
			window.location.reload();
		}
	</script>
</html>
